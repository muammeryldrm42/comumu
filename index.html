<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#0b0e14" />
  <title>Cow Traffic Racer ‚Äî HTML5 (TR/EN)</title>
  <style>
    :root{
      --bg:#0b0e14; --road:#171c25; --lane:#e7edf7; --edge:#364155; --ui:#ffffff; --dim:#a6b0c2; --accent:#ff6b6b;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ui);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;overflow:hidden}
    canvas{display:block;width:100vw;height:100vh;touch-action:none;background:var(--bg)}

    /* HUD (fixed & layered) */
    .hud{position:fixed;inset:0;z-index:10}
    .hud .top{position:absolute;top:env(safe-area-inset-top);left:0;right:0;padding:8px 10px;display:flex;justify-content:space-between;align-items:center;gap:8px;pointer-events:auto}
    .badge{background:#ffffff14;border:1px solid #ffffff22;border-radius:12px;padding:6px 9px;font-weight:700;backdrop-filter:blur(6px);box-shadow:0 10px 28px rgba(0,0,0,.35);font-size:12px}
    .btn{pointer-events:auto;cursor:pointer;border:0;border-radius:10px;padding:7px 10px;font-weight:800;background:#ffffff1a;color:#fff;box-shadow:inset 0 0 0 1px #ffffff33,0 6px 18px rgba(0,0,0,.25);transition:.12s;font-size:12px}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btnbar{display:flex;gap:6px;pointer-events:auto}

    /* Panels */
    .panel{position:absolute;inset:0;display:grid;place-items:center;padding:20px;z-index:20}
    .card{width:min(520px,92vw);background:#151923cc;border:1px solid #ffffff24;border-radius:18px;box-shadow:0 36px 96px rgba(0,0,0,.5);padding:18px}
    .card h1{margin:0 0 6px;font-size:clamp(22px,3vw,30px)}
    .card p{margin:0 0 10px;color:var(--dim)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .row>*{flex:1}
    .kbd{font-weight:800;border:1px solid #ffffff44;border-bottom-width:3px;border-radius:6px;padding:2px 6px}

    /* Touch */
    .touch{position:absolute;left:50%;bottom:calc(10px + env(safe-area-inset-bottom));transform:translateX(-50%);display:flex;gap:8px}
    .tbtn{pointer-events:auto;width:56px;height:56px;border-radius:12px;background:#ffffff12;box-shadow:0 12px 36px rgba(0,0,0,.35),inset 0 0 0 1px #ffffff22;display:grid;place-items:center;font-size:22px;user-select:none;touch-action:manipulation}
    .tbtn:active{transform:translateY(1px)}
    @media (min-width: 900px){.touch{display:none}}

    .langbar{display:flex;gap:6px}
    .langbtn{pointer-events:auto;border:0;border-radius:8px;padding:4px 8px;background:#ffffff14;color:#fff;font-weight:800;font-size:12px}
    .langbtn.active{background:#ffffff2a}
  </style>
</head>
<body>
  <canvas id="game" aria-label="Cow Traffic Racer"></canvas>

  <div class="hud">
    <div class="top">
      <div class="badge" id="score">Score: 0</div>
      <div class="btnbar">
        <div class="langbar">
          <button id="lang-tr" class="langbtn">TR</button>
          <button id="lang-en" class="langbtn">EN</button>
        </div>
        <button id="pause" class="btn" title="Pause/Resume">‚èØÔ∏è</button>
        <button id="restart" class="btn" title="Restart">üîÑ</button>
        <button id="fs" class="btn" title="Fullscreen">‚õ∂</button>
      </div>
      <div class="badge" id="best">Best: 0</div>
    </div>

    <div class="panel" id="menu">
      <div class="card">
        <h1 id="title">üêÑ Cow Traffic Racer</h1>
        <p id="desc">Drive your cow-pattern car through traffic without crashing.</p>
        <div class="row" style="margin:10px 0">
          <button class="btn diff" data-diff="easy" id="btn-easy">Easy</button>
          <button class="btn diff" data-diff="normal" id="btn-normal">Normal</button>
          <button class="btn diff" data-diff="hard" id="btn-hard">Hard</button>
        </div>
        <div class="row">
          <button class="btn" id="start">‚ñ∂Ô∏è Start (Enter)</button>
        </div>
        <p class="muted" id="hint" style="margin-top:8px"></p>
      </div>
    </div>

    <div class="panel" id="over" style="display:none;">
      <div class="card">
        <h1 id="over-title">üí• Crash!</h1>
        <p id="final">Score: 0</p>
        <div class="row" style="margin-top:10px">
          <button id="again" class="btn">Play Again</button>
          <button id="tomenu" class="btn">Menu</button>
        </div>
      </div>
    </div>

    <div class="touch">
      <div class="tbtn" id="tleft">‚¨ÖÔ∏è</div>
      <div class="tbtn" id="tgas">‚è´</div>
      <div class="tbtn" id="tbrake">‚è¨</div>
      <div class="tbtn" id="tright">‚û°Ô∏è</div>
    </div>
  </div>

  <script>
  // ===== i18n =====
  const I18N = {
    en: {
      title: 'üêÑ Cow Traffic Racer',
      desc: 'Drive your cow-pattern car through traffic without crashing.',
      hint: 'Controls: ‚Üê/‚Üí or A/D to change lane ‚Ä¢ W/‚Üë gas ‚Ä¢ S/‚Üì brake ‚Ä¢ P pause. Press Enter to start.',
      score: 'Score', best: 'Best', start: '‚ñ∂Ô∏è Start (Enter)',
      easy: 'Easy', normal: 'Normal', hard: 'Hard',
      pause: 'Pause/Resume', restart: 'Restart', fs: 'Fullscreen',
      crash: 'üí• Crash!', again: 'Play Again', menu: 'Menu', milk: 'Milk'
    },
    tr: {
      title: 'üêÑ ƒ∞nek Trafik Yarƒ±≈üƒ±',
      desc: 'ƒ∞nek desenli arabanla trafikte √ßarpmadan ilerle.',
      hint: 'Kontroller: ≈ûerit i√ßin ‚Üê/‚Üí veya A/D ‚Ä¢ Gaz W/‚Üë ‚Ä¢ Fren S/‚Üì ‚Ä¢ P durdur. Ba≈ülamak i√ßin Enter.',
      score: 'Skor', best: 'Rekor', start: '‚ñ∂Ô∏è Ba≈ülat (Enter)',
      easy: 'Kolay', normal: 'Normal', hard: 'Zor',
      pause: 'Durdur/Devam', restart: 'Yeniden Ba≈ülat', fs: 'Tam ekran',
      crash: 'üí• Kaza!', again: 'Yeniden Oyna', menu: 'Men√º', milk: 'S√ºt'
    }
  };
  let LANG = (localStorage.getItem('cow.lang')) || (((navigator.language||'').toLowerCase().startsWith('tr')) ? 'tr' : 'en');
  function t(k){ return I18N[LANG][k] || k; }
  function setLang(l){ LANG=l; localStorage.setItem('cow.lang', l); updateTexts(); }
  function updateTexts(){
    document.getElementById('title').textContent = t('title');
    document.getElementById('desc').textContent = t('desc');
    document.getElementById('hint').textContent = t('hint');
    document.getElementById('btn-easy').textContent = t('easy');
    document.getElementById('btn-normal').textContent = t('normal');
    document.getElementById('btn-hard').textContent = t('hard');
    document.getElementById('start').textContent = t('start');
    document.getElementById('pause').title = t('pause');
    document.getElementById('restart').title = t('restart');
    document.getElementById('fs').title = t('fs');
    document.getElementById('over-title').textContent = t('crash');
    document.getElementById('again').textContent = t('again');
    document.getElementById('tomenu').textContent = t('menu');
    document.getElementById('score').textContent = `${t('score')}: ${Math.floor(Game.score)} ‚Ä¢ üçº ${t('milk')}: ${Game.milk}`;
    document.getElementById('best').textContent = `${t('best')}: ${Math.floor(Math.max(Game.best, Game.score))}`;
    document.documentElement.lang = LANG;
  }

  // ---------- Canvas & size ----------
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');
  let DPR = Math.max(1, Math.floor(window.devicePixelRatio || 1));
  let W = 0, H = 0;
  function resize(){
    DPR = Math.max(1, Math.floor(window.devicePixelRatio || 1));
    const vw = Math.max(320, window.innerWidth);
    const vh = Math.max(420, window.innerHeight);
    W = Math.floor(vw * DPR); H = Math.floor(vh * DPR);
    cvs.width = W; cvs.height = H; cvs.style.width = vw + 'px'; cvs.style.height = vh + 'px';
    layout();
  }
  window.addEventListener('resize', resize, { passive:true });

  // ---------- Config ----------
  const STATE = { MENU:0, RUN:1, PAUSE:2, OVER:3 };
  const CONFIG = {
    lanes: 5,
    roadMargin: 0.05,
    baseSpeed: 360,
    maxSpeed: 1000,
    accel: 240,
    brake: 420,
    npcMinGap: 1.2,
    spawnBase: 0.85,
    spawnScale: 0.55,
    laneLineLen: 56,
    laneLineGap: 56,
    carToLaneRatio: 0.48,
    playerHeightRatio: 1.95,
    npcSpeedVar: 0.65,
    crashMargin: 0.10,
    milkSpawnBase: 2.2,
    milkSpawnScale: 0.8
  };

  let ROAD = { x:0, w:0, laneW:0, h:0 };
  const sizes = { carW:0, carH:0 };
  function layout(){
    ROAD.w = Math.floor(W * (1 - CONFIG.roadMargin*2));
    ROAD.h = H; ROAD.x = Math.floor((W - ROAD.w) / 2); ROAD.laneW = Math.floor(ROAD.w / CONFIG.lanes);
    sizes.carW = Math.floor(ROAD.laneW * CONFIG.carToLaneRatio);
    sizes.carH = Math.floor(sizes.carW * CONFIG.playerHeightRatio);
  }

  // ---------- Patterns & Skins ----------
  function mulberry32(seed){ return function(){ let t = seed += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; }; }
  function makeCowPattern(seed=123){
    const off = document.createElement('canvas'); const S = 96; off.width = S; off.height = S; const o = off.getContext('2d');
    const rnd = mulberry32(seed); o.fillStyle = '#fff'; o.fillRect(0,0,S,S);
    for(let i=0;i<14;i++){ o.fillStyle = '#111'; const cx = rnd()*S, cy = rnd()*S; const rx = 6 + rnd()*30, ry = 6 + rnd()*30; o.beginPath(); o.ellipse(cx, cy, rx, ry, rnd()*Math.PI, 0, Math.PI*2); o.fill(); if(rnd()>0.6){ o.beginPath(); o.ellipse(cx+rx*(rnd()*0.8-0.4), cy+ry*(rnd()*0.8-0.4), rx*0.45, ry*0.45, rnd()*Math.PI, 0, Math.PI*2); o.fill(); } }
    return ctx.createPattern(off, 'repeat');
  }
  function makeZebraPattern(seed=321){
    const off = document.createElement('canvas'); const Wp=120, Hp=80; off.width=Wp; off.height=Hp; const o=off.getContext('2d');
    o.fillStyle = '#fff'; o.fillRect(0,0,Wp,Hp); o.save(); o.translate(Wp/2,Hp/2); o.rotate(-0.35);
    o.translate(-Wp/2,-Hp/2);
    o.fillStyle = '#111'; const stride=14; for(let x=-Wp; x<Wp*2; x+=stride){ o.fillRect(x, -Hp, stride*0.5, Hp*3); }
    o.restore();
    return ctx.createPattern(off,'repeat');
  }
  function makeAsphaltPattern(){
    const off = document.createElement('canvas'); const S = 128; off.width = S; off.height = S; const o = off.getContext('2d');
    o.fillStyle = '#1b212c'; o.fillRect(0,0,S,S);
    for(let i=0;i<1000;i++){ const g = 30+Math.floor(Math.random()*60); o.fillStyle = `rgba(${g},${g+5},${g+10},${0.12+Math.random()*0.1})`; o.fillRect(Math.random()*S, Math.random()*S, 1, 1); }
    for(let i=0;i<140;i++){ o.fillStyle = 'rgba(255,255,255,0.05)'; o.fillRect(Math.random()*S, Math.random()*S, 1, 1); }
    return ctx.createPattern(off, 'repeat');
  }
  const asphalt = makeAsphaltPattern();

  function makeSkin(kind='cow', seed=(Math.random()*1e9)|0){
    const palettes = ['#e74c3c','#1abc9c','#3498db','#9b59b6','#f1c40f','#e67e22','#2ecc71','#e84393'];
    switch(kind){
      case 'cow': return { type:'pattern', paint: makeCowPattern(seed) };
      case 'zebra': return { type:'pattern', paint: makeZebraPattern(seed) };
      case 'solid': return { type:'solid', color: palettes[seed % palettes.length] };
      case 'stripe': return { type:'stripe', color: palettes[(seed>>2) % palettes.length], stripe:'#ffffff' };
      case 'taxi': return { type:'checker', color:'#f5c400', stripe:'#111' };
      case 'police': return { type:'police', color:'#111', stripe:'#fff' };
      default: return { type:'solid', color: palettes[0] };
    }
  }

  // ---------- Helpers ----------
  function roundRect(x,y,w,h,r){ const rr=Math.min(r,w/2,h/2); ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath(); }
  function aabbHit(a,b){ return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y; }
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const lerp = (a,b,t)=>a+(b-a)*t;

  // ---------- Car Classes ----------
  class Car{
    constructor(lane, y, speed=0, skinKind='cow', seed=1){
      this.lane = lane; this.y = y; this.speed = speed; this.w = sizes.carW; this.h = sizes.carH;
      this.skin = makeSkin(skinKind, seed);
      this.x = ROAD.x + lane*ROAD.laneW + (ROAD.laneW - this.w)/2;
    }
    get aabb(){ const m = CONFIG.crashMargin; return { x:this.x+this.w*m, y:this.y+this.h*m, w:this.w*(1-2*m), h:this.h*(1-2*m) }; }
    draw(){
      ctx.save(); ctx.translate(this.x, this.y);
      const tw = this.w*0.16, th = this.h*0.15, offX = this.w*0.06, offY = this.h*0.08;
      ctx.fillStyle = '#0b0b0b';
      ctx.fillRect(offX, offY, tw, th); ctx.fillRect(this.w - offX - tw, offY, tw, th);
      ctx.fillRect(offX, this.h - offY - th, tw, th); ctx.fillRect(this.w - offX - tw, this.h - offY - th, tw, th);
      ctx.fillStyle = 'rgba(0,0,0,.28)'; ctx.fillRect(6, this.h-4, this.w-12, 5);
      ctx.fillStyle = (this.skin.type==='pattern') ? this.skin.paint : (this.skin.color || '#fff');
      ctx.strokeStyle = '#101214'; ctx.lineWidth = 2.5;
      roundRect(0,0,this.w,this.h, Math.min(14, this.w*0.12)); ctx.fill(); ctx.stroke();
      if(this.skin.type==='stripe'){
        ctx.fillStyle = this.skin.stripe; ctx.fillRect(this.w*0.48, this.h*0.02, this.w*0.04, this.h*0.96);
      } else if(this.skin.type==='checker'){
        ctx.fillStyle = this.skin.stripe; const y = this.h*0.65; const sz = this.w*0.08; for(let i=0;i<6;i++){ if(i%2===0) ctx.fillRect(this.w*0.12+i*sz, y, sz, sz*0.6); }
      } else if(this.skin.type==='police'){
        ctx.fillStyle = '#fff'; ctx.fillRect(this.w*0.18, this.h*0.35, this.w*0.64, this.h*0.3);
        ctx.fillStyle = '#1e90ff'; ctx.fillRect(this.w*0.42, this.h*0.06, this.w*0.14, this.h*0.06);
        ctx.fillStyle = '#ff4b5c'; ctx.fillRect(this.w*0.56, this.h*0.06, this.w*0.14, this.h*0.06);
      }
      const g1 = ctx.createLinearGradient(0,0,0,this.h*0.5); g1.addColorStop(0,'rgba(255,255,255,.18)'); g1.addColorStop(1,'rgba(255,255,255,0)');
      ctx.fillStyle = g1; roundRect(this.w*0.06, this.h*0.02, this.w*0.88, this.h*0.32, 8); ctx.fill();
      const g2 = ctx.createLinearGradient(0,this.h*0.5,0,this.h); g2.addColorStop(0,'rgba(255,255,255,.10)'); g2.addColorStop(1,'rgba(255,255,255,0)');
      ctx.fillStyle = g2; roundRect(this.w*0.08, this.h*0.52, this.w*0.84, this.h*0.30, 10); ctx.fill();
      ctx.fillStyle = '#072136'; roundRect(this.w*0.14, this.h*0.10, this.w*0.72, this.h*0.20, 8); ctx.fill();
      roundRect(this.w*0.20, this.h*0.40, this.w*0.60, this.h*0.18, 10); ctx.fill();
      ctx.fillStyle = '#1a1a1a'; ctx.fillRect(-this.w*0.05, this.h*0.28, this.w*0.08, this.h*0.08);
      ctx.fillRect(this.w - this.w*0.03, this.h*0.28, this.w*0.08, this.h*0.08);
      ctx.fillStyle = '#ffe27a'; ctx.fillRect(this.w*0.16, -2, this.w*0.18, 4); ctx.fillRect(this.w*0.66, -2, this.w*0.18, 4);
      ctx.fillStyle = '#ff5757'; ctx.fillRect(this.w*0.16, this.h-2, this.w*0.18, 4); ctx.fillRect(this.w*0.66, this.h-2, this.w*0.18, 4);
      ctx.restore();
    }
  }
  class PlayerCar extends Car{
    constructor(){ super(Math.floor(CONFIG.lanes/2), 0, 0, 'cow', 777); this.y = H - this.h - 18*DPR; this.targetLane = this.lane; }
    setLane(dir){ this.targetLane = clamp(this.targetLane + dir, 0, CONFIG.lanes-1); }
    update(dt, input){
      let desired = Game.speed;
      if(input.accel) desired += CONFIG.accel; else if(input.brake) desired -= CONFIG.brake; else desired = lerp(Game.speed, CONFIG.baseSpeed, 1 - Math.exp(-2*dt));
      Game.speed = clamp(desired, CONFIG.baseSpeed*0.6, CONFIG.maxSpeed);
      const targetX = ROAD.x + this.targetLane*ROAD.laneW + (ROAD.laneW - this.w)/2; this.x = lerp(this.x, targetX, 1 - Math.exp(-16*dt));
      const center = this.x + this.w/2; this.lane = clamp(Math.floor((center - ROAD.x)/ROAD.laneW),0,CONFIG.lanes-1);
    }
  }
  class NpcCar extends Car{ update(dt){ this.y += (Game.speed*0.75 + this.speed) * dt; } }

  // ---------- Milk ----------
  class Milk{
    constructor(lane, y){ this.lane=lane; this.w = sizes.carW*0.35; this.h=this.w*1.2; this.x = ROAD.x + lane*ROAD.laneW + (ROAD.laneW - this.w)/2; this.y=y; }
    get aabb(){ return { x:this.x+this.w*0.2, y:this.y+this.h*0.1, w:this.w*0.6, h:this.h*0.8 }; }
    update(dt){ this.y += Game.speed * dt; }
    draw(){
      ctx.save(); ctx.translate(this.x,this.y);
      // bottle
      ctx.fillStyle = '#ffffff'; roundRect(0, this.h*0.1, this.w, this.h*0.85, this.w*0.18); ctx.fill();
      ctx.fillStyle = '#7ec8ff'; roundRect(this.w*0.15, this.h*0.35, this.w*0.7, this.h*0.35, 6); ctx.fill();
      ctx.fillStyle = '#d6eaff'; roundRect(this.w*0.32, 0, this.w*0.36, this.h*0.18, 6); ctx.fill(); // cap
      ctx.restore();
    }
  }

  // ---------- Road ----------
  const Road = {
    offset:0,
    update(dt){ this.offset += Game.speed * dt; },
    draw(){
      ctx.fillStyle = '#0b0e14'; ctx.fillRect(0,0,W,H);
      ctx.fillStyle = asphalt; ctx.fillRect(ROAD.x-10*DPR, 0, ROAD.w+20*DPR, H);
      ctx.fillStyle = '#2c3649'; ctx.fillRect(ROAD.x-6*DPR, 0, 6*DPR, H); ctx.fillRect(ROAD.x+ROAD.w, 0, 6*DPR, H);
      ctx.save(); ctx.strokeStyle = '#e7edf7'; ctx.lineWidth = 4*DPR; ctx.setLineDash([CONFIG.laneLineLen*DPR, CONFIG.laneLineGap*DPR]);
      ctx.lineDashOffset = - (this.offset % ((CONFIG.laneLineLen+CONFIG.laneLineGap)*DPR));
      for(let i=1;i<CONFIG.lanes;i++){ const x = Math.floor(ROAD.x + i*ROAD.laneW); ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
      ctx.restore();
    }
  };

  // ---------- Input ----------
  const Input = { left:false, right:false, accel:false, brake:false };
  function hookInput(){
    window.addEventListener('keydown', e=>{
      const k = e.key.toLowerCase();
      if(Game.state===STATE.MENU && k==='enter'){ Game.start(); return; }
      if(k==='arrowleft'||k==='a') Game.player.setLane(-1);
      if(k==='arrowright'||k==='d') Game.player.setLane(+1);
      if(k==='arrowup'||k==='w')  Input.accel=true;
      if(k==='arrowdown'||k==='s') Input.brake=true;
      if(k==='p') Game.togglePause();
      if(Game.state===STATE.OVER && k==='r') Game.restart();
    });
    window.addEventListener('keyup', e=>{
      const k = e.key.toLowerCase();
      if(k==='arrowup'||k==='w')  Input.accel=false;
      if(k==='arrowdown'||k==='s') Input.brake=false;
    });
    document.getElementById('start').addEventListener('click', ()=> Game.start());
    cvs.addEventListener('touchstart', ()=>{ if(Game.state===STATE.MENU) Game.start(); }, {passive:true});
    const tleft = document.getElementById('tleft');
    const tright = document.getElementById('tright');
    const tgas = document.getElementById('tgas');
    const tbrake = document.getElementById('tbrake');
    tleft.addEventListener('click', ()=> Game.player.setLane(-1));
    tright.addEventListener('click', ()=> Game.player.setLane(+1));
    tgas.addEventListener('touchstart', ()=> Input.accel=true); tgas.addEventListener('touchend', ()=> Input.accel=false);
    tbrake.addEventListener('touchstart', ()=> Input.brake=true); tbrake.addEventListener('touchend', ()=> Input.brake=false);
  }

  // ---------- UI handles ----------
  const ui = {
    score: document.getElementById('score'), best: document.getElementById('best'), menu: document.getElementById('menu'), over: document.getElementById('over'), final: document.getElementById('final'), pause: document.getElementById('pause'), restart: document.getElementById('restart'), again: document.getElementById('again'), tomenu: document.getElementById('tomenu'), fs: document.getElementById('fs'), langTr: document.getElementById('lang-tr'), langEn: document.getElementById('lang-en') };

  const Game = {
    state: STATE.MENU,
    speed: CONFIG.baseSpeed,
    score: 0,
    milk: 0,
    best: Number(localStorage.getItem('cow.best')||0),
    player: null,
    npcs: [],
    milks: [],
    lastSpawn: 0,
    lastMilk: 0,
    diff: { name:'normal', mult:1 },
    setDifficulty(name){ const m = name==='easy'?0.85: name==='hard'?1.2: 1; this.diff = { name, mult:m }; CONFIG.maxSpeed = 1000*m; },
    start(){ this.player = new PlayerCar(); this.npcs=[]; this.milks=[]; this.score=0; this.milk=0; this.speed=CONFIG.baseSpeed; this.lastSpawn=0; this.lastMilk=0; this.state=STATE.RUN; ui.menu.style.display='none'; ui.over.style.display='none'; },
    restart(){ this.start(); },
    togglePause(){ if(this.state===STATE.RUN){ this.state=STATE.PAUSE; } else if(this.state===STATE.PAUSE){ this.state=STATE.RUN; lastTime = performance.now(); } },
    over(){ this.state=STATE.OVER; Input.accel=false; Input.brake=false; if(navigator.vibrate) try{ navigator.vibrate([40,60,40]); }catch(e){} if(this.score>this.best){ this.best=this.score; localStorage.setItem('cow.best', String(this.best)); } ui.final.textContent = `${t('score')}: ${Math.floor(this.score)} ‚Ä¢ ${t('best')}: ${Math.floor(this.best)} ‚Ä¢ üçº ${t('milk')}: ${this.milk}`; ui.over.style.display=''; }
  };

  function canSpawnInLane(lane){ const minY = -sizes.carH * CONFIG.npcMinGap; for(const c of Game.npcs){ if(c.lane===lane && c.y < sizes.carH*CONFIG.npcMinGap + minY) return false; } return true; }
  function randomSkin(){ const kinds = ['zebra','solid','stripe','taxi','police','cow']; return kinds[(Math.random()*kinds.length)|0]; }
  function laneClearForMilk(lane, y){ const box = { x: ROAD.x + lane*ROAD.laneW + (ROAD.laneW - sizes.carW*0.35)/2, y, w: sizes.carW*0.35, h: sizes.carW*0.35*1.2 }; for(const c of Game.npcs){ if(c.lane!==lane) continue; const a=c.aabb; const b={ x:box.x, y:box.y, w:box.w, h:box.h }; if(aabbHit(a,b)) return false; } return true; }
  function spawnNPC(){ const lanes = [...Array(CONFIG.lanes).keys()].filter(canSpawnInLane); if(lanes.length===0) return; const lane = lanes[Math.floor(Math.random()*lanes.length)]; const rel = (Math.random()*2-1)*(CONFIG.npcSpeedVar*Game.speed); const seed=(Math.random()*1e9)|0; const skin=randomSkin(); Game.npcs.push(new NpcCar(lane, -sizes.carH-10*DPR, rel, skin, seed)); }
  function spawnMilk(){ const lane = (Math.random()*CONFIG.lanes)|0; const y = -sizes.carH*0.6 - 10*DPR; if(laneClearForMilk(lane, y)) Game.milks.push(new Milk(lane, y)); }
  function spawnLogic(dt){ Game.lastSpawn += dt; Game.lastMilk += dt; const interval = (CONFIG.spawnBase + CONFIG.spawnScale * (CONFIG.maxSpeed / Math.max(Game.speed, 80))) / Game.diff.mult; if(Game.lastSpawn >= interval){ Game.lastSpawn = 0; spawnNPC(); if(Math.random()>0.65) spawnNPC(); } const milkInt = (CONFIG.milkSpawnBase + CONFIG.milkSpawnScale * (CONFIG.maxSpeed / Math.max(Game.speed, 80))) / Game.diff.mult; if(Game.lastMilk >= milkInt){ Game.lastMilk = 0; spawnMilk(); } }

  function enforceNpcSpacing(){
    const lanes = Array.from({length: CONFIG.lanes}, ()=>[]);
    for(const c of Game.npcs) lanes[c.lane].push(c);
    const gap = sizes.carH * CONFIG.npcMinGap;
    for(const arr of lanes){
      arr.sort((a,b)=>b.y - a.y); // front first
      for(let i=1;i<arr.length;i++){
        const front = arr[i-1]; const back = arr[i];
        const allowedY = front.y - gap - back.h;
        if(back.y > allowedY){ back.y = allowedY; back.speed = Math.min(back.speed, front.speed); }
      }
    }
  }

  // ---------- Loop ----------
  let lastTime = performance.now();
  function loop(now){ requestAnimationFrame(loop); const dt = Math.min(0.033, (now - lastTime)/1000); lastTime = now; if(Game.state===STATE.RUN){ update(dt); } draw(); }

  function update(dt){
    Road.update(dt);
    Game.player.update(dt, Input);
    for(const c of Game.npcs) c.update(dt);
    for(const m of Game.milks) m.update(dt);
    enforceNpcSpacing();
    Game.npcs = Game.npcs.filter(c => c.y < H + sizes.carH*2);
    Game.milks = Game.milks.filter(m => m.y < H + sizes.carH);
    spawnLogic(dt);
    for(const c of Game.npcs){ if(aabbHit(Game.player.aabb, c.aabb)){ Game.over(); break; } }
    // collect milk
    for(let i=Game.milks.length-1;i>=0;i--){ if(aabbHit(Game.player.aabb, Game.milks[i].aabb)){ Game.milk++; Game.milks.splice(i,1); } }
    Game.score += (Game.speed/CONFIG.baseSpeed) * dt * 10;
    ui.score.textContent = `${t('score')}: ${Math.floor(Game.score)} ‚Ä¢ üçº ${t('milk')}: ${Game.milk}`;
    ui.best.textContent = `${t('best')}: ${Math.floor(Math.max(Game.best, Game.score))}`;
  }
  function draw(){ Road.draw(); for(const m of Game.milks) m.draw(); for(const c of Game.npcs) c.draw(); if(Game.player) Game.player.draw(); }

  // ---------- UI setup ----------
  function hookUI(){
    document.querySelectorAll('.diff').forEach(b=> b.addEventListener('click', ()=>{ Game.setDifficulty(b.dataset.diff); }));
    document.getElementById('start').addEventListener('click', ()=> Game.start());
    ui.pause.addEventListener('click', ()=> Game.togglePause());
    ui.restart.addEventListener('click', ()=> Game.restart());
    ui.again.addEventListener('click', ()=> Game.restart());
    ui.tomenu.addEventListener('click', ()=>{ Game.state=STATE.MENU; ui.menu.style.display=''; ui.over.style.display='none'; });
    ui.fs.addEventListener('click', ()=>{ const el=document.documentElement; if(!document.fullscreenElement){ el.requestFullscreen?.(); } else { document.exitFullscreen?.(); } });
    ui.langTr.addEventListener('click', ()=>{ setLang('tr'); ui.langTr.classList.add('active'); ui.langEn.classList.remove('active'); });
    ui.langEn.addEventListener('click', ()=>{ setLang('en'); ui.langEn.classList.add('active'); ui.langTr.classList.remove('active'); });
  }

  // ---------- Init ----------
  hookInput(); hookUI(); resize(); updateTexts();
  if(LANG==='tr'){ ui.langTr.classList.add('active'); } else { ui.langEn.classList.add('active'); }
  Game.state = STATE.MENU; Game.player = new PlayerCar();
  requestAnimationFrame(loop);
  </script>
</body>
</html>
